<div class="relative w-full h-full bg-black-alpha-80">
  <p-scrollPanel class="h-full w-full" styleClass="absolute h-full w-full">
    <div class="my-1">
      <ng-container *ngFor="let file of files$ | async | orderBy : 'name:string' | orderBy : '-isDirectory:number'">
        <ng-template [ngTemplateOutlet]="fileItem" [ngTemplateOutletContext]="{ item: file, level: 0 }"></ng-template>
      </ng-container>
    </div>

    <ng-template #fileItem let-item="item" let-level="level">
      <ng-container *ngIf="toItem(item) as item">
        <div (click)="setSelectedItem(item)" (contextmenu)="toggleContextMenu($event, item)">
          <div class="mx-3 border-round-md" [class.surface-600]="(selectedItem$ | async)?.fullPath === item.fullPath">
            <div class="flex align-items-center gap-1 py-1" [ngStyle]="{ 'margin-left.px': 14 * level }">
              <div>
                <i
                  *ngIf="item.isDirectory; else notDirectory"
                  class="pi text-gray-50 font-bold"
                  [class.pi-angle-down]="(openedDirectories$ | async).includes(item.fullPath)"
                  [class.pi-angle-right]="!(openedDirectories$ | async).includes(item.fullPath)"
                  (click)="toggleOpenedDirectory(item.fullPath); $event.stopPropagation()"
                ></i>
                <ng-template #notDirectory>
                  <div class="w-1rem"></div>
                </ng-template>
              </div>
              <img [ngSrc]="item | fileTypeImagePath" width="18" height="18" [alt]="item.name" />
              <p class="select-none font-medium white-space-nowrap">
                {{ item.name }}
              </p>
              <p *ngIf="level === 0" class="select-none font-normal text-gray-300 white-space-nowrap">
                {{ item.fullPath }}
              </p>
            </div>
          </div>
        </div>

        <ng-container *ngIf="item.children?.length && (openedDirectories$ | async).includes(item.fullPath)">
          <ng-container *ngFor="let childFile of item.children | orderBy : 'name:string' | orderBy : '-isDirectory:number'">
            <ng-template [ngTemplateOutlet]="fileItem" [ngTemplateOutletContext]="{ item: childFile, level: level + 1 }"></ng-template>
          </ng-container>
        </ng-container>
      </ng-container>
    </ng-template>
  </p-scrollPanel>
</div>

<p-contextMenu #contextMenu [model]="contextMenuItems"></p-contextMenu>

<p-dialog
  [(visible)]="isShowDialog"
  [style]="{ width: '25rem' }"
  [closable]="false"
  [resizable]="false"
  (onDragEnd)="onDragEndDialog()"
  (keyup.escape)="clickToEscape()"
  (keyup.enter)="onClickEnterDialog()"
  appExternalEvents
  (onClickExternal)="onClickExternalDialog()"
  (onContextMenuExternal)="onContextMenuExternalDialog()"
>
  <ng-template pTemplate="header">
    <span class="font-medium text-white text-center w-full">{{ textHeaderDialog }}</span>
  </ng-template>
  <div class="w-full border-top-1 border-black-alpha-90"></div>
  <form [formGroup]="formDialog">
    <input
      type="text"
      pInputText
      formControlName="name"
      class="w-full {{ formDialog.get('name').invalid && formDialog.get('name').value ? 'border-error' : '' }}"
      placeholder="Название"
      appInfiniteAutofocus
      [isModal]="true"
      [isShowModal]="isShowDialog"
      [pTooltip]="formDialog.get('name').errors | parseFormErrorToString : directoryErrorsForm"
      [tooltipStyleClass]="formDialog.get('name').errors ? 'is-error' : ''"
      tooltipEvent="focus"
      tooltipPosition="bottom"
    />
  </form>
</p-dialog>
